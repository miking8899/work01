
L帝은　@sddlmZddlZddljZddlZddlm	Z	ddl
Z
ddlmZddlZddlZddlmZeje
぀ddlZddlmZeje぀Zdd	䀀Zd
d䀀Zdd䀀Zdd䀀Zdd䀀Zdd䀀Zdd䀀ZdS)退)چrenderN)ڑcandlestick2_ochl)ڇBytesIO隨)چmodels)ڊconnectioncCstjd぀t|dむS)Nzstart to display main.htmlz	main.html)چloggerڄinfor)ڇrequest進壽D:\software\java web\清華出版社\PythonWorkSpace\MyDjangoOBVProj\src\MyDjangoOBVProj\mainForm.pyڇdisplaysrcCstjd぀|dd|d<d|d<d}x<t|぀dkr|j|d|j|ddkr懟j|ddf|j|df|j|df<n|j|d|j|ddkr|j|ddf|j|df|j|df<n|d}q2W|S)	Nzstart calOBVچVolumei@BZ	VolByHandrڃOBVrڅClose)rr	ڃlenڄilocZix)ڂdfڃcntrrrچcalOBVs
&8&8rcCstjd぀tjjjd|、j　tj|d||ダ}|j	|j
t|぀dddぁd|||d}|j|぀tj|d	d
ぁ}d}g}x뀼t|぀dkr灼j|d}t|j|d぀}t|j|d぀}	t|j|d぀}
t|j|d぀}t|j|d぀}tjd|d|d|	d|
d|d|d|Ｏ}|j|぀|d}q퀗tjjj|぀|S)Nzstart insertDataډstockCodez.ssrZinplaceTzD:\stockData\ch12\z.csvڈencodingڃgbkrڄDateڄOpenrڄHighڃLowrڄdateڄopenڅcloseڄhighڃlowڃvol)rr	rډstockInfoڇobjectsچfilterچdeleteڑpandas_datareaderZget_data_yahooڄdropڅindexrZto_csvڂpdZread_csvrڅfloatڃintچappendڋbulk_create)rډstartDateڇendDateZstockڈfilenamerZstockInfoListrrrڊr r!r"ZstockOnerrr뀀insertData(s*$6r2cCs぀tjd぀tj　}z~yb|jd|d|d|d぀dddd	d
dg}|j　}tjt|぀぀}Wntj	d぀YnXWd|j
　Xt|Ādkr぀||_|Stjdダt|||ꁧ}|SdS)Nzstart loadStockzDselect date,high,low,open,close,vol from stockInfo where stockCode='z' and date>='z' and date<='چrrrrrrz2in loadStock,error during visiting stockInfo tablerzNo data in DB, get from Web)rr	rڇcursorڈexecuteڄfetchallr*Z	DataFrameڅlistڇerrorrچrډcolumnsr2)rr/r0r4Zheads぀resultrrrrꁼloadStockBs %	r;cCsd}d}x||t|぀dkr぀dkr}|j|dd|j|dkr}|j|dd|j|ddkr}tjd|j|d぀tjd	t|j|dd
぀぀tjdt|j|dd
぀぀tjdt|j|d
ڀꁬ|j|dd
|j|d
krz|j|dd
|j|dd
krz||j|dd}qzq}n|d}qW|S)Nrڅr酀r邀z#calBuyPoints, descrease for 2 days.rzobv on first day is:rzobv on second day is:zobv on third day is:ڃ)rrrڇdebugڌstr)rr぀buyDaterrrꁼcalBuyPointsZsP&&"P"rCcCsd}d}x||t|぀dkr぀dkr}|j|dd|j|dkr}|j|dd|j|ddkr}tjd|j|d぀tjd	t|j|dd
぀぀tjdt|j|dd
぀぀tjdt|j|d
ڈڍ|j|dd
|j|d
krz|j|dd
|j|dd
krz||j|dd}qzq}n|d}qW|S)Nrr<rr=rr>z#calSellPoints, increase for 2 days.rzobv on first day is:rzobv on second day is:zobv on third day is:r?)rrrr@rA)rr぀sellDaterrr぀calSellPointsjsP&&"P"rEcCs\tjd぀|jjd぀}tjd|぀|jjd぀}tjd|぀|jjdダ}tjd|぀t|||ぁ}t|぀}tj　}|jdd	d
぀\}}t	d|d|dj
d|dj
d|dj
d|dj
dddddd〈|jd぀|djdd、j　jd|dddd぀〃|djdd 、j　jd|dd!dd"〃|djdd#、j　jd|dddd$〃|jd%d&、|jd'む|jd(d)、|d*jd|dd!dd*〃tjd%d&、d+gtjd,<d-tjd.<|jd/ぁ|jd0぀|jd(d)、|j|jd d1k}|d2|jd d1k}	tj||	぀tjtj　j　d3d4぀tjd5぀t　}
tj|
぀tj　tj|
j　぀}d6|jダ　}tjd7څt |迚}t!|ڃ}t"|d8i|d96|d6|d:6|d;6څS)<Nz
start drawrzstockCode is:r/zstartDate is:r0zendDate is:r>ZsharexTZaxZopensrZclosesrZhighsrZlowsrچwidthg郀colorupڅredZ	colordownڅgreenuK線圖和均線圖ڄwindowڃڃcolorڄlabelu
3天均線r=ڃblueu
5天均線銀u10天均線ڃlocZbestu價格（單位：元）Z	linestylez-.rZSimHeizfont.sans-serifFzaxes.unicode_minusu單位：萬手uOBV指標圖rrZrotation鞀zconvert plt to bufferzdata:image/png;base64,zstart to Render in stock.htmlz
stock.htmlچimgrBrD)#rr	چPOSTچgetr;rچpltډfigureZsubplotsrڈvaluesZ	set_titleZrollingZmeanZplotچlegendZ
set_ylabelZgridZrcParamsr)ZxticksZsetpZgcaZget_xticklabelsr@rZsavefigrچڄbase64ڃb64encodeڂgetvalueڃdecoderCrEr)r
rr/r0rrUZaxPriceZaxOBVZmajor_indexZmajor_xticsچbufferZ	base64imgrQrBrDrrrڇdrawzsZ222 ډ	
r])ډZdjango.shortcutsrr'Zmatplotlib.pyplotZpyplotrTZpandasr*Zmpl_financerڈsysڈiorrXڈimpr<rڈreloadڈloggingڈdjango.dbrڈgetLoggerڈ__name__rrrr2r;rCrEr]rrrrڈ<module>s(